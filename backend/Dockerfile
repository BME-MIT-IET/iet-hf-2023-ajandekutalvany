# âš’ Build the builder image
FROM node:18-bullseye AS prodbuild

# ğŸ¤« Silence npm
ENV NPM_CONFIG_LOGLEVEL=error

# ğŸ‘‡ Create working directory and assign ownership
WORKDIR /code

# ğŸ‘‡ Copy config files and source
COPY package*.json tsconfig.json ./
COPY prisma ./prisma/

# ğŸ‘‡ Install deps and build source
RUN yarn install --frozen-lockfile

COPY src ./src
RUN yarn build

# ğŸš€ Build the runner image
FROM node:18-bullseye-slim AS runner

# Add openssl and tini
RUN apt-get -qy update && apt-get -qy install openssl tini

# Tini is now available at /sbin/tini
ENTRYPOINT ["/usr/bin/tini", "--"]

# ğŸ‘‡ Create working directory and assign ownership
WORKDIR /code

# ğŸ‘‡ Copy the built app from the prodbuild image
COPY --from=prodbuild /code ./

# âš™ï¸ Configure the default command
CMD ["npm", "run", "start:prod"]